cmake_minimum_required(VERSION 3.12)
set(PICO_BOARD tdata)
#set(PICO_BUILD_BOOT_STAGE2_NAME boot2_is25lp080)
#set(PICO_BUILD_BOOT_STAGE2_NAME boot2_generic_03h)

include(pico_sdk_import.cmake)

project(pilomar C CXX ASM)
set(CMAKE_C_STANDARD 11)
set(CMAKE_CXX_STANDARD 17)

pico_sdk_init()

# LWIP
set(LWIP_DIR ${PICO_SDK_PATH}/lib/lwip)
set (LWIP_INCLUDE_DIRS
    "${LWIP_DIR}/src/include"
    "${CMAKE_CURRENT_SOURCE_DIR}"
    )

include(${LWIP_DIR}/src/Filelists.cmake)
include(${PICO_TINYUSB_PATH}/hw/bsp/family_support.cmake)
# Extra stuff from TinyUSB, that is not part of tinyusb_device library
set(TINYUSB_LIBNETWORKING_SOURCES
    ${PICO_TINYUSB_PATH}/lib/networking
    )

add_executable(pilomar
    main.cpp
    Motor.cpp Motor.h
    tusb_lwip_glue.c usb_descriptors.c
    ${TINYUSB_LIBNETWORKING_SOURCES}/dhserver.c
    ${TINYUSB_LIBNETWORKING_SOURCES}/dnserver.c
    ${TINYUSB_LIBNETWORKING_SOURCES}/rndis_reports.c
    )

pico_enable_stdio_usb(pilomar 0)
pico_enable_stdio_uart(pilomar 1)

target_include_directories(pilomar PRIVATE
    ${CMAKE_CURRENT_LIST_DIR}
    ${LWIP_INCLUDE_DIRS}
    ${PICO_TINYUSB_PATH}/src
    ${PICO_TINYUSB_PATH}/hw
    ${TINYUSB_LIBNETWORKING_SOURCES}
    )

target_link_libraries(pilomar
    pico_stdlib
    pico_multicore
    hardware_pwm
    hardware_timer
    pico_unique_id
    tinyusb_device
    lwipcore
)

pico_add_extra_outputs(pilomar)

add_custom_command(TARGET pilomar POST_BUILD
    COMMAND /usr/local/bin/openocd -f interface/cmsis-dap.cfg -f target/rp2040.cfg -c "adapter speed 5000" -c "program build/pilomar.elf verify reset exit"
    WORKING_DIRECTORY ${CMAKE_CURRENT_LIST_DIR}
    COMMENT Flashing...)